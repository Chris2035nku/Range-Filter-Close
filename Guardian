//@version=5
indicator(title="Range Filter Close 3 (Guardian)", shorttitle="Range Close 3", overlay=true)

upColor = color.white
midColor = #90bff9
downColor = color.blue

src = input(defval=close, title="Source")
per = input.int(defval=233, minval=1, title="Sampling Period")
mult = input.float(defval=4.2, minval=0.1, title="Range Multiplier")

groupZones = "Premium/Discount Zones"
zoneMult = input.float(2.0, "Zone Multiplier", minval=0.5, step=0.1, group=groupZones)
requirePremiumShort = input.bool(true, "Require Premium Tap Before Short", group=groupZones)
requireDiscountLong = input.bool(true, "Require Discount Tap Before Long", group=groupZones)

groupTradeMgmt = "Trade Management"
trailMult = input.float(1.0, "ATR Trail Multiplier", minval=0.1, step=0.1, group=groupTradeMgmt)
useMidlineExit = input.bool(true, "Exit When Price Crosses Filter", group=groupTradeMgmt)
maxBarsInTrade = input.int(20, "Max Bars In Trade", minval=1, group=groupTradeMgmt)

groupShortFilters = "Short Accuracy Filters"
shortRsiLen = input.int(14, "Short RSI Length", minval=2, group=groupShortFilters)
shortRsiMax = input.float(55.0, "Max RSI For Shorts", minval=0.0, maxval=100.0, step=0.1, group=groupShortFilters)
maxLowerWickRatio = input.float(1.5, "Max Lower Wick : Body", minval=0.1, step=0.1, group=groupShortFilters)
requireBearishShort = input.bool(true, "Require Bearish Candle To Short", group=groupShortFilters)

groupExitFilters = "Exit Filters"
requireBearishExitClose = input.bool(true, "Require bearish candle to exit long", group=groupExitFilters)
requireExitBelowFilter = input.bool(true, "Require close below filter to exit long", group=groupExitFilters)
minLongBarsBeforeExit = input.int(5, "Minimum bars in long trade before exit", minval=0, group=groupExitFilters)

smoothrng(x, t, m) =>
    wper = t * 2 - 1
    avrng = ta.ema(math.abs(x - x[1]), t)
    ta.ema(avrng, wper) * m
smrng = smoothrng(src, per, mult)

rngfilt(x, r) =>
    rngfilt = x
    rngfilt := x > nz(rngfilt[1]) ? x - r < nz(rngfilt[1]) ? nz(rngfilt[1]) : x - r : x + r > nz(rngfilt[1]) ? nz(rngfilt[1]) : x + r
    rngfilt
filt = rngfilt(src, smrng)

upward = 0.0
upward := filt > filt[1] ? nz(upward[1]) + 1 : filt < filt[1] ? 0 : nz(upward[1])
downward = 0.0
downward := filt < filt[1] ? nz(downward[1]) + 1 : filt > filt[1] ? 0 : nz(downward[1])

hband = filt + smrng
lband = filt - smrng
premiumBand = filt + smrng * zoneMult
discountBand = filt - smrng * zoneMult

filtcolor = upward > 0 ? upColor : downward > 0 ? downColor : midColor
barcolorSeries = src > filt and src > src[1] and upward > 0 ? upColor : src > filt and src < src[1] and upward > 0 ? upColor : src < filt and src < src[1] and downward > 0 ? downColor : src < filt and src > src[1] and downward > 0 ? downColor : midColor

filtplot = plot(filt, color=filtcolor, linewidth=2, title="Range Filter")
hbandplot = plot(hband, color=color.new(upColor, 70), title="High Target")
lbandplot = plot(lband, color=color.new(downColor, 70), title="Low Target")
premiumPlot = plot(premiumBand, color=color.new(color.red, 70), title="Premium Zone", linewidth=1, style=plot.style_linebr)
discountPlot = plot(discountBand, color=color.new(color.green, 70), title="Discount Zone", linewidth=1, style=plot.style_linebr)
fill(hbandplot, filtplot, color=color.new(upColor, 90), title="High Target Range")
fill(lbandplot, filtplot, color=color.new(downColor, 90), title="Low Target Range")
barcolor(barcolorSeries)

longCond = bool(na)
shortCond = bool(na)
longCond := src > filt and src > src[1] and upward > 0 or src > filt and src < src[1] and upward > 0
shortCond := src < filt and src < src[1] and downward > 0 or src < filt and src > src[1] and downward > 0

CondIni = 0
CondIni := longCond ? 1 : shortCond ? -1 : CondIni[1]

shortRsi = ta.rsi(src, shortRsiLen)
bodySize = math.abs(close - open)
lowerWick = math.min(open, close) - low
lowerWickRatio = bodySize != 0 ? lowerWick / bodySize : 999.0
shortMomentumOk = shortRsi < shortRsiMax
shortBearishOk = not requireBearishShort or close <= open
shortWickOk = lowerWickRatio <= maxLowerWickRatio
shortFiltersOk = shortMomentumOk and shortBearishOk and shortWickOk

longCondition = longCond and CondIni[1] == -1
shortCondition = shortCond and CondIni[1] == 1 and shortFiltersOk

discountTouch = close < discountBand or low < discountBand
premiumTouch = close > premiumBand or high > premiumBand
longCondition := longCondition and (not requireDiscountLong or discountTouch)
shortCondition := shortCondition and (not requirePremiumShort or (premiumTouch and close < open))

var bool inLongTrade = false
var bool inShortTrade = false
var float longTrail = na
var float shortTrail = na
var int longBars = 0
var int shortBars = 0
exitLongSignal = false
exitShortSignal = false

if longCondition
    inLongTrade := true
    inShortTrade := false
    longTrail := src - smrng * trailMult
    shortTrail := na
    longBars := 0
    shortBars := 0

if shortCondition
    inShortTrade := true
    inLongTrade := false
    shortTrail := src + smrng * trailMult
    longTrail := na
    shortBars := 0
    longBars := 0

if inLongTrade
    longBars += 1
    trailCandidate = src - smrng * trailMult
    longTrail := na(longTrail) ? trailCandidate : math.max(longTrail, trailCandidate)
    stopHit = src < longTrail
    midExit = useMidlineExit and src < filt
    timeExit = longBars >= maxBarsInTrade
    exitFiltersOk = longBars >= minLongBarsBeforeExit and (not requireBearishExitClose or close < open) and (not requireExitBelowFilter or close < filt)
    if (stopHit or midExit or timeExit) and exitFiltersOk
        exitLongSignal := true
        inLongTrade := false
        longTrail := na
        longBars := 0

if inShortTrade
    shortBars += 1
    trailCandidate = src + smrng * trailMult
    shortTrail := na(shortTrail) ? trailCandidate : math.min(shortTrail, trailCandidate)
    stopHit = src > shortTrail
    midExit = useMidlineExit and src > filt
    timeExit = shortBars >= maxBarsInTrade
    if stopHit or midExit or timeExit
        exitShortSignal := true
        inShortTrade := false
        shortTrail := na
        shortBars := 0

plotshape(longCondition, title="Buy Signal", text="Buy", textcolor=color.white, style=shape.labelup, size=size.small, location=location.belowbar, color=color.new(#aaaaaa, 20))
plotshape(shortCondition, title="Sell Signal", text="Sell", textcolor=color.white, style=shape.labeldown, size=size.small, location=location.abovebar, color=color.new(downColor, 20))
plotshape(exitLongSignal, title="Exit Long", text="Exit", style=shape.labeldown, location=location.abovebar, color=color.new(color.yellow, 0), textcolor=color.black, size=size.tiny)
plotshape(exitShortSignal, title="Exit Short", text="Cover", style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), textcolor=color.white, size=size.tiny)

alertcondition(longCondition, title="Buy alert on Range Filter", message="Buy alert on Range Filter")
alertcondition(shortCondition, title="Sell alert on Range Filter", message="Sell alert on Range Filter")
alertcondition(longCondition or shortCondition, title="Buy and Sell alert on Range Filter", message="Buy and Sell alert on Range Filter")
alertcondition(exitLongSignal, title="Range Filter Exit Long", message="Range Filter exit long triggered")
alertcondition(exitShortSignal, title="Range Filter Exit Short", message="Range Filter exit short triggered")
